<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>URL Shortener</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="/admin.css" />
	</head>
	<body>
		<div class="page-container container">
			<h1>üîó URL Shortener</h1>

			<div class="form-section bg-white p-4 rounded shadow mb-4">
				<form id="shortenForm">
					<div class="mb-3">
						<label for="url" class="form-label">URL to Shorten:</label>
						<input type="url" class="form-control" id="url" name="url" required placeholder="https://example.com/very/long/url" />
					</div>

					<div class="mb-3">
						<label for="customPath" class="form-label">Custom Path (optional):</label>
						<input type="text" class="form-control" id="customPath" name="customPath" placeholder="my-custom-link" />
					</div>

					<div class="d-flex gap-2 flex-wrap">
						<button type="submit" class="btn btn-primary flex-fill">Shorten URL</button>
						<button type="button" class="btn btn-secondary flex-fill" onclick="loadLinks()">Refresh Links</button>
					</div>
				</form>

				<div id="result"></div>
			</div>

			<div class="links-section">
				<h2>üìã Your Short Links</h2>
				<div id="linksList">Loading...</div>
			</div>
		</div>

		<script>
			// Load existing links on page load
			document.addEventListener('DOMContentLoaded', loadLinks);

			// Handle form submission
			document.getElementById('shortenForm').addEventListener('submit', async (e) => {
			    e.preventDefault();

			    const url = document.getElementById('url').value;
			    const customPath = document.getElementById('customPath').value;
			    const resultDiv = document.getElementById('result');

			    try {
			        const response = await fetch('/api/shorten', {
			            method: 'POST',
			            headers: {
			                'Content-Type': 'application/json',
			            },
			            body: JSON.stringify({ url, customPath })
			        });

			        const data = await response.json();

			        if (response.ok) {
			            resultDiv.innerHTML = \`
			                <div class="alert alert-success">
			                    ‚úÖ Short URL created successfully!
			                    <div class="short-url">\${data.shortUrl}</div>
			                </div>
			            \`;
			            document.getElementById('shortenForm').reset();
			            loadLinks();
			        } else {
			            resultDiv.innerHTML = \`
			                <div class="alert alert-danger">
			                    ‚ùå Error: \${data.error}
			                </div>
			            \`;
			        }
			    } catch (error) {
			        resultDiv.innerHTML = \`
			            <div class="alert alert-danger">
			                ‚ùå Network error: \${error.message}
			            </div>
			        \`;
			    }
			});

			// Load and display all links
			async function loadLinks() {
			    const linksDiv = document.getElementById('linksList');

			    try {
			        const response = await fetch('/api/links');
			        const links = await response.json();

			        if (links.length === 0) {
			            linksDiv.innerHTML = '<p class="text-center text-muted fst-italic">No short links created yet.</p>';
			            return;
			        }

			        linksDiv.innerHTML = links.map(link => \`
			            <div class="link-item" id="link-\${link.path}">
			                <div class="flex-grow-1 me-3">
			                    <div class="link-short">
			                        <a href="/\${link.path}" target="_blank">\${window.location.origin}/\${link.path}</a>
			                    </div>
			                    <div class="link-target">‚Üí \${link.url}</div>
			                </div>
			                <div class="link-actions">
			                    <button class="btn btn-warning btn-sm" onclick="editLink('\${link.path}', '\${link.url}')">
			                        ‚úèÔ∏è Edit
			                    </button>
			                    <button class="btn btn-danger btn-sm" onclick="deleteLink('\${link.path}')">
			                        üóëÔ∏è Delete
			                    </button>
			                </div>
			            </div>
			        \`).join('');
			    } catch (error) {
			        linksDiv.innerHTML = \`<p class="text-danger">Error loading links: \${error.message}</p>\`;
			    }
			}

			// Edit link functionality
			function editLink(path, currentUrl) {
			    const linkItem = document.getElementById(\`link-\${path}\`);
			    const editForm = \`
			        <div class="edit-form">
			            <input type="url" class="form-control" id="edit-url-\${path}" value="\${currentUrl}" placeholder="New URL">
			            <div class="d-flex gap-2 flex-wrap">
			                <button class="btn btn-primary btn-sm" onclick="saveEdit('\${path}')">üíæ Save</button>
			                <button class="btn btn-secondary btn-sm" onclick="cancelEdit('\${path}')">‚ùå Cancel</button>
			            </div>
			        </div>
			    \`;
			    linkItem.innerHTML += editForm;
			}

			// Save edit
			async function saveEdit(path) {
			    const newUrl = document.getElementById(\`edit-url-\${path}\`).value;

			    try {
			        const response = await fetch('/api/update', {
			            method: 'PUT',
			            headers: {
			                'Content-Type': 'application/json',
			            },
			            body: JSON.stringify({ path, url: newUrl })
			        });

			        if (response.ok) {
			            loadLinks();
			        } else {
			            const data = await response.json();
			            alert('Error updating link: ' + data.error);
			        }
			    } catch (error) {
			        alert('Network error: ' + error.message);
			    }
			}

			// Cancel edit
			function cancelEdit(path) {
			    loadLinks();
			}

			// Delete link
			async function deleteLink(path) {
			    if (!confirm(\`Are you sure you want to delete the short link "/$\{path}"?\`)) {
			        return;
			    }

			    try {
			        const response = await fetch('/api/delete', {
			            method: 'DELETE',
			            headers: {
			                'Content-Type': 'application/json',
			            },
			            body: JSON.stringify({ path })
			        });

			        if (response.ok) {
			            loadLinks();
			        } else {
			            const data = await response.json();
			            alert('Error deleting link: ' + data.error);
			        }
			    } catch (error) {
			        alert('Network error: ' + error.message);
			    }
			}
		</script>
	</body>
</html>
